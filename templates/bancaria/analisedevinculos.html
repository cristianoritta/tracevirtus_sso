{% extends 'layout/base.html' %}
{% load static %}

{% block css %}
<style>
    .container {
        height: 100vh;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    #graph {
        flex: 1;
        min-height: 0;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
    }

    .legend {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .icon-controls {
        position: fixed;
        top: 120px;
        right: 32px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        padding: 8px 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        border-radius: 50%;
        position: relative;
    }

    .icon-btn:hover {
        background: #e3e3e3;
    }

    .icon-btn svg {
        width: 28px;
        height: 28px;
        fill: #1976d2;
    }

    #download-popup {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: white;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        min-width: 160px;
        z-index: 1001;
    }

    #download-popup a {
        display: block;
        padding: 8px 12px;
        color: #333;
        text-decoration: none;
        border-radius: 4px;
        transition: background 0.2s;
    }

    #download-popup a:hover {
        background: #f5f5f5;
    }

    .envolvido-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .envolvido-modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.2);
        position: relative;
    }

    .envolvido-modal-close {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
    }

    .envolvido-modal-close:hover {
        color: #d32f2f;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="nk-block-head nk-block-head-sm">
        <div class="nk-block-between">
            <div class="nk-block-head-content">
                <h3 class="nk-block-title page-title">{{ title }}</h3>
                <div class="nk-block-des text-soft">
                    <p>{{ subtitle }}</p>
                </div>
            </div>
        </div>
    </div>
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background-color: #1976d2;"></div>
            <span>Titular da Cooperação</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #000000;"></div>
            <span>Outros Envolvidos</span>
        </div>
        <div class="legend-item">
            <div style="width: 20px; height: 2px; background-color: #2e7d32;"></div>
            <span>Vínculo de Crédito</span>
        </div>
        <div class="legend-item">
            <div style="width: 20px; height: 2px; background-color: #d32f2f;"></div>
            <span>Vínculo de Débito</span>
        </div>
    </div>
    <div id="graph" style="width: 100%; height: 70vh;"></div>
    
    <div class="icon-controls">
        <button id="play-pause-btn" class="icon-btn" title="Iniciar Movimento">
            <svg id="play-icon" viewBox="0 0 24 24" style="display:block;"><polygon points="8,5 19,12 8,19" /></svg>
            <svg id="pause-icon" viewBox="0 0 24 24" style="display:none;"><rect x="6" y="5" width="4" height="14" /><rect x="14" y="5" width="4" height="14" /></svg>
        </button>
        <button id="download-btn" class="icon-btn" title="Download">
            <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            <div id="download-popup" style="display:none;">
                <a href="/bancaria/analisedevinculos/download_csv" id="download-csv" target="_blank">
                    <em class="icon ni ni-file-text"></em><span>Download CSV</span>
                </a>
            </div>
        </button>
    </div>

    <div id="envolvido-modal" class="envolvido-modal" style="display:none;">
        <div class="envolvido-modal-content" style="max-width: 60% !important;">
            <span class="envolvido-modal-close" id="envolvido-modal-close">&times;</span>
            <div id="envolvido-modal-body"><!-- Conteúdo dinâmico --></div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    const nodes = {{ nodes|safe }};
    const links = {{ links|safe }};
    const width = document.getElementById('graph').clientWidth;
    const height = document.getElementById('graph').clientHeight;

    const svg = d3.select("#graph").append("svg").attr("width", width).attr("height", height);
    const graphGroup = svg.append("g").attr("class", "graph-group");
    const zoom = d3.zoom().scaleExtent([0.1, 5]).on("zoom", (event) => graphGroup.attr("transform", event.transform));
    svg.call(zoom);

    let simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(width / 2, height / 2));

    let isMoving = false;

    function getNodeColor(tipo) {
        return tipo === 'Titular' ? '#1976d2' : '#000000';
    }

    function findConnectedNodes(centerId, depth = 2) {
        const connectedNodes = new Set([centerId]);
        const connectedLinks = new Set();
        function findConnections(nodeId, currentDepth) {
            if (currentDepth <= 0) return;
            links.forEach(link => {
                if (link.source === nodeId || link.target === nodeId) {
                    const connectedNode = link.source === nodeId ? link.target : link.source;
                    if (!connectedNodes.has(connectedNode)) {
                        connectedNodes.add(connectedNode);
                        connectedLinks.add(link);
                        findConnections(connectedNode, currentDepth - 1);
                    }
                }
            });
        }
        findConnections(centerId, depth);
        return { nodes: Array.from(connectedNodes), links: Array.from(connectedLinks) };
    }

    function updateGraph(centerId) {
        const { nodes: connectedNodes, links: connectedLinks } = findConnectedNodes(centerId);
        graphGroup.selectAll("*").remove();

        simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(120))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const link = graphGroup.append("g").selectAll("line").data(links).join("line")
            .attr("stroke", d => d.natureza === 'C' ? '#2e7d32' : '#d32f2f')
            .attr("stroke-opacity", d => (d.source.id === centerId || d.target.id === centerId || connectedLinks.some(l => l.source.id === d.source.id && l.target.id === d.target.id)) ? 1 : 0.2)
            .attr("stroke-width", d => (d.source.id === centerId || d.target.id === centerId) ? 2 : 1);
        
        const edgeLabels = graphGroup.append("g").selectAll("text").data(links).join("text")
            .text(d => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(d.value))
            .attr('font-size', '8px').attr('fill', '#555').attr('text-anchor', 'middle')
            .style("opacity", d => (d.source.id === centerId || d.target.id === centerId || connectedLinks.some(l => l.source.id === d.source.id && l.target.id === d.target.id)) ? 1 : 0);


        const node = graphGroup.append("g").selectAll("circle").data(nodes).join("circle")
            .attr("r", d => d.id === centerId ? 12 : 8)
            .attr("fill", d => getNodeColor(d.tipo))
            .attr("stroke", d => d.id === centerId ? "#fff" : "none")
            .attr("stroke-width", 2)
            .style("cursor", "pointer")
            .call(drag(simulation));

        const label = graphGroup.append("g").selectAll("text").data(nodes).join("text")
            .text(d => d.nome)
            .attr("font-size", d => d.id === centerId ? 12 : 10)
            .attr("dx", 10).attr("dy", 4)
            .attr("fill", d => getNodeColor(d.tipo))
            .attr("font-weight", d => d.id === centerId ? "bold" : "normal");
        
        simulation.on("tick", () => {
            link.attr("x1", d => getNodeById(nodes, d.source).x).attr("y1", d => getNodeById(nodes, d.source).y)
                .attr("x2", d => getNodeById(nodes, d.target).x).attr("y2", d => getNodeById(nodes, d.target).y);
            
            edgeLabels.attr("x", d => (getNodeById(nodes, d.source).x + getNodeById(nodes, d.target).x) / 2)
                      .attr("y", d => (getNodeById(nodes, d.source).y + getNodeById(nodes, d.target).y) / 2);

            node.attr("cx", d => d.x).attr("cy", d => d.y);
            label.attr("x", d => d.x).attr("y", d => d.y);
        });

        node.on("click", (event, d) => { if (d.id !== centerId) updateGraph(d.id); });
        addDblClickToNodes();
    }

    function getNodeById(nodesArr, id) {
        return typeof id === 'object' ? id : nodesArr.find(n => n.id === id);
    }

    function drag(sim) {
        function dragstarted(event, d) { if (!event.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
        function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
        function dragended(event, d) { if (!event.active) sim.alphaTarget(0); d.fx = null; d.fy = null; }
        return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
    }
    
    function updateGraphAll() {
        graphGroup.selectAll("*").remove();
        simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(120))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const link = graphGroup.append("g").selectAll("line").data(links).join("line")
            .attr("stroke", d => d.natureza === 'C' ? '#2e7d32' : '#d32f2f')
            .attr("stroke-opacity", 1)
            .attr("stroke-width", d => Math.sqrt(d.value) / 1000 + 1);
        
        const edgeLabels = graphGroup.append("g").selectAll("text").data(links).join("text")
            .text(d => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(d.value))
            .attr('font-size', '8px').attr('fill', '#555').attr('text-anchor', 'middle')
            .style("opacity", 1);

        const node = graphGroup.append("g").selectAll("circle").data(nodes).join("circle").attr("r", 8).attr("fill", d => getNodeColor(d.tipo)).style("cursor", "pointer").call(drag(simulation));
        const label = graphGroup.append("g").selectAll("text").data(nodes).join("text").text(d => d.nome).attr("font-size", 10).attr("dx", 10).attr("dy", 4).attr("fill", d => getNodeColor(d.tipo));

        simulation.on("tick", () => {
            link.attr("x1", d => getNodeById(nodes, d.source).x).attr("y1", d => getNodeById(nodes, d.source).y)
                .attr("x2", d => getNodeById(nodes, d.target).x).attr("y2", d => getNodeById(nodes, d.target).y);
            
            edgeLabels.attr("x", d => (getNodeById(nodes, d.source).x + getNodeById(nodes, d.target).x) / 2)
                      .attr("y", d => (getNodeById(nodes, d.source).y + getNodeById(nodes, d.target).y) / 2);

            node.attr("cx", d => d.x).attr("cy", d => d.y);
            label.attr("x", d => d.x).attr("y", d => d.y);
        });
        node.on("click", (event, d) => updateGraph(d.id));
        addDblClickToNodes();
    }

    const playPauseBtn = document.getElementById('play-pause-btn');
    playPauseBtn.addEventListener('click', () => {
        isMoving = !isMoving;
        if (isMoving) { simulation.alpha(0.3).restart(); playPauseBtn.title = 'Pausar'; } 
        else { simulation.stop(); playPauseBtn.title = 'Iniciar'; }
        document.getElementById('play-icon').style.display = isMoving ? 'none' : 'block';
        document.getElementById('pause-icon').style.display = isMoving ? 'block' : 'none';
    });

    function addDblClickToNodes() {
        d3.selectAll('circle').on('dblclick', (event, d) => {
            showEnvolvidoModal(d.cpf_cnpj);
            event.stopPropagation();
        });
    }

    function showEnvolvidoModal(cpf_cnpj) {
        const modal = document.getElementById('envolvido-modal');
        const modalBody = document.getElementById('envolvido-modal-body');
        modal.style.display = 'block';
        modalBody.innerHTML = 'Carregando...';
        fetch(`/bancaria/envolvido_detalhes/${cpf_cnpj}/`)
            .then(resp => resp.text())
            .then(html => { modalBody.innerHTML = html; })
            .catch(() => { modalBody.innerHTML = 'Erro ao carregar.'; });
    }
    
    document.getElementById('envolvido-modal-close').onclick = () => document.getElementById('envolvido-modal').style.display = 'none';
    window.onclick = (event) => { if (event.target == document.getElementById('envolvido-modal')) document.getElementById('envolvido-modal').style.display = 'none'; };

    const downloadBtn = document.getElementById('download-btn');
    const downloadPopup = document.getElementById('download-popup');
    downloadBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        downloadPopup.style.display = downloadPopup.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
        if (!downloadBtn.contains(e.target)) downloadPopup.style.display = 'none';
    });
    
    updateGraphAll();
</script>
{% endblock %} 