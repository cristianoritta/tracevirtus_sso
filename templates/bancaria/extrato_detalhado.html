{% extends 'layout/base.html' %}
{% load static %}
{% load mask %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="nk-block-head nk-block-head-sm">
        <div class="nk-block-between">
            <div class="nk-block-head-content">
                <h3 class="nk-block-title page-title">{{ title }}</h3>
                <div class="nk-block-des text-soft">
                    <p>{{ subtitle }}</p>
                </div>
            </div>
            <div class="nk-block-head-content">
                <form id="filterForm" method="get" class="form-inline">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cooperacaoFilter" class="mr-2">Cooperação:</label>
                                <select name="cooperacao_id" id="cooperacaoFilter" class="form-control"
                                    onchange="document.getElementById('filterForm').submit();">
                                    <option value="all">Todas</option>
                                    {% for coop in cooperacoes %}
                                    <option value="{{ coop.id }}" {% if
                                        selected_cooperacao_id|stringformat:"s"==coop.id|stringformat:"s" %}selected{%
                                        endif %}>
                                        {{ coop.numero }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cooperacaoFilter" class="mr-2">Alvos:</label>
                                <select name="cooperacao_id" id="cooperacaoFilter" class="form-control"
                                    onchange="document.getElementById('filterForm').submit();">
                                    <option value="all">Todas</option>
                                    {% for coop in cooperacoes %}
                                    <option value="{{ coop.id }}" {% if
                                        selected_cooperacao_id|stringformat:"s"==coop.id|stringformat:"s" %}selected{%
                                        endif %}>
                                        {{ coop.numero }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cooperacaoFilter" class="mr-2">Alvos:</label>
                                <input type="text" name="alvo" id="alvo" class="form-control" placeholder="Buscar alvo">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cooperacaoFilter" class="mr-2">Contrapartes:</label>
                                <input type="text" name="alvo" id="alvo" class="form-control" placeholder="Buscar alvo">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cooperacaoFilter" class="mr-2">Período:</label>
                                <input type="date" name="alvo" id="alvo" class="form-control" placeholder="Buscar alvo">
                                <input type="date" name="alvo" id="alvo" class="form-control" placeholder="Buscar alvo">
                            </div>
                        </div>

                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- Tabela de Extrato Detalhado -->
    <div class="card card-bordered card-preview">
        <div class="card-inner">
            <table class="datatable-init-export nowrap table" data-export-title="Extrato Detalhado">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Titular</th>
                        <th>CPF/CNPJ</th>
                        <th>Descrição</th>
                        <th class="text-end">Valor (R$)</th>
                        <th>Natureza</th>
                        <th>Origem/Destino</th>
                        <th>CPF</th>
                    </tr>
                </thead>
                <tbody>
                    {% for extrato in extratos %}
                    <tr>
                        <td>{{ extrato.data_lancamento|date:"d/m/Y" }}</td>
                        <td>{{ extrato.nome_titular|truncatechars:30 }}</td>
                        <td>{{ extrato.cpf_cnpj_titular|mask:'cpf_cnpj' }}</td>
                        <td>{{ extrato.descricao_lancamento|truncatechars:40 }}</td>
                        <td class="text-end">{{ extrato.valor_transacao|real }}</td>
                        <td class="text-center">
                            <span
                                class="badge badge-dim {% if extrato.natureza_lancamento == 'C' %}badge-success{% else %}badge-danger{% endif %}">
                                {{ extrato.get_natureza_lancamento_display }}
                            </span>
                        </td>
                        <td>{{ extrato.nome_pessoa_od|truncatechars:30 }}</td>
                        <td>{{ extrato.cpf_cnpj_od|mask:'cpf_cnpj' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>

<script>
    $(document).ready(function () {
        // Adiciona uma nova linha no cabeçalho para os filtros
        $('.datatable-init-export thead tr').clone(true).appendTo('.datatable-init-export thead');
        $('.datatable-init-export thead tr:eq(1) th').each(function (i) {
            var title = $(this).text();
            $(this).html('<input type="text" class="form-control form-control-sm" placeholder="Buscar ' + title + '" />');
        });

        var table = $('.datatable-init-export').DataTable({
            orderCellsTop: true,
            fixedHeader: true,
            responsive: true,
            dom: 'Bfrtip',
            buttons: [
                'copy', 'csv', 'excel', 'pdf', 'print'
            ],
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/Portuguese-Brasil.json"
            },
            initComplete: function () {
                // Aplica a busca por coluna
                this.api().columns().every(function () {
                    var that = this;
                    $('input', $('.datatable-init-export thead tr:eq(1) th')[this.index()]).on('keyup change clear', function () {
                        if (that.search() !== this.value) {
                            that
                                .search(this.value)
                                .draw();
                        }
                    });
                });
            }
        });
    });
</script>
{% endblock %}