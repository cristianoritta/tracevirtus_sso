{% extends 'layout/base.html' %}
{% load static %}
{% load mask %}

{% block css %}
<style>
    .card-detalhes {
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .card-header-custom {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 15px 20px;
        font-weight: 600;
        color: #495057;
    }

    .info-item {
        padding: 10px 0;
        border-bottom: 1px solid #f1f3f4;
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: #495057;
        min-width: 150px;
    }

    .info-value {
        color: #6c757d;
    }

    .dados-financeiros {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 15px 0;
    }

    .campo-financeiro {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        text-align: center;
    }

    .campo-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }

    .campo-valor {
        font-size: 1.1em;
        color: #007bff;
    }

    .titular-card {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-bottom: 15px;
        overflow: hidden;
    }

    .titular-header {
        background-color: #007bff;
        color: white;
        padding: 15px 20px;
        font-weight: 600;
    }

    .titular-body {
        padding: 20px;
    }

    .transacao-item {
        background-color: #f8f9fa;
        border-left: 3px solid #007bff;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 3px;
    }

    .transacao-credito {
        border-left-color: #28a745;
    }

    .transacao-debito {
        border-left-color: #dc3545;
    }

    .btn-voltar {
        margin-bottom: 20px;
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }

    .saldo-positivo {
        color: #28a745;
    }

    .saldo-negativo {
        color: #dc3545;
    }

    .estatisticas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .estatistica-card {
        border: 2px solid #dee2e6;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }

    .estatistica-valor {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .estatistica-label {
        font-size: 0.9em;
        opacity: 0.9;
    }

    /* Estilos para o modal de análise IA */
    #conteudo-analise {
        max-height: 70vh;
        overflow-y: auto;
        padding: 15px;
    }

    #conteudo-analise h1,
    #conteudo-analise h2,
    #conteudo-analise h3,
    #conteudo-analise h4,
    #conteudo-analise h5,
    #conteudo-analise h6 {
        color: #495057;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    #conteudo-analise h1 {
        font-size: 1.8em;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
    }

    #conteudo-analise h2 {
        font-size: 1.5em;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 3px;
    }

    #conteudo-analise p {
        line-height: 1.6;
        margin-bottom: 15px;
    }

    #conteudo-analise ul,
    #conteudo-analise ol {
        margin-bottom: 15px;
        padding-left: 20px;
    }

    #conteudo-analise li {
        margin-bottom: 5px;
    }

    #conteudo-analise strong {
        color: #007bff;
        font-weight: 600;
    }

    #conteudo-analise em {
        color: #6c757d;
        font-style: italic;
    }

    #conteudo-analise blockquote {
        border-left: 4px solid #007bff;
        padding-left: 15px;
        margin: 15px 0;
        color: #6c757d;
        font-style: italic;
    }

    #conteudo-analise code {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        color: #e83e8c;
    }

    #conteudo-analise pre {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        border: 1px solid #dee2e6;
    }

    #conteudo-analise table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }

    #conteudo-analise th,
    #conteudo-analise td {
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        text-align: left;
    }

    #conteudo-analise th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-1">{{ title }}</h3>
            <p class="text-muted mb-0">{{ subtitle }}</p>
        </div>
        <div>
            <button id="btn-analise-ia" class="btn btn-primary me-2">
                <i class="icon fa fa-robot"></i><span> Análise com IA</span>
            </button>
            <a href="javascript:history.back()" class="btn btn-outline-secondary">
                <i class="icon fa fa-arrow-left"></i><span> Voltar</span>
            </a>
        </div>
    </div>

    <!-- Dados da Pessoa -->
    <div class="card card-detalhes">
        <div class="card-header-custom">
            <i class="fa fa-user"></i> Informações da Pessoa
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item d-flex">
                        <span class="info-label">Nome:</span>
                        <span class="info-value">{{ pessoa.nome }}</span>
                    </div>
                    <div class="info-item d-flex">
                        <span class="info-label">CPF/CNPJ:</span>
                        <span class="info-value">{{ pessoa.cpf_cnpj|mask:'cpf_cnpj' }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item d-flex">
                        <span class="info-label">Total de Transações:</span>
                        <span class="info-value">{{ pessoa.total_transacoes }}</span>
                    </div>
                    <div class="info-item d-flex">
                        <span class="info-label">Saldo:</span>
                        <span
                            class="info-value {% if pessoa.saldo >= 0 %}saldo-positivo{% else %}saldo-negativo{% endif %}">
                            {{ pessoa.saldo|mask:'moeda' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas -->
    <div class="estatisticas-grid">
        <div class="estatistica-card">
            <div class="estatistica-valor">{{ pessoa.total_valor|mask:'moeda' }}</div>
            <div class="estatistica-label">Valor Total Movimentado</div>
        </div>
        <div class="estatistica-card">
            <div class="estatistica-valor">{{ pessoa.creditos|mask:'moeda' }}</div>
            <div class="estatistica-label">Total de Créditos</div>
        </div>
        <div class="estatistica-card">
            <div class="estatistica-valor">{{ pessoa.debitos|mask:'moeda' }}</div>
            <div class="estatistica-label">Total de Débitos</div>
        </div>
        <div class="estatistica-card">
            <div class="estatistica-valor">{{ pessoa.total_transacoes }}</div>
            <div class="estatistica-label">Total de Transações</div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row">
        <div class="col-md-6">
            <div class="card card-detalhes">
                <div class="card-header-custom">
                    <i class="fa fa-chart-pie"></i> Distribuição Créditos vs Débitos
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="grafico-pizza" data-grafico='{{ dados_grafico|safe }}'></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card card-detalhes">
                <div class="card-header-custom">
                    <i class="fa fa-chart-line"></i> Movimentação ao Longo do Tempo
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="grafico-linha" data-linha='{{ dados_linha|safe }}'></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transações por Titular -->
    {% if transacoes_por_titular %}
    <div class="card card-detalhes">
        <div class="card-header-custom">
            <i class="fa fa-university"></i> Transações por Conta Bancária
        </div>
        <div class="card-body">
            {% for titular_key, titular_data in transacoes_por_titular.items %}
            <div class="titular-card">
                <div class="titular-header">
                    <i class="fa fa-user-circle"></i> {{ titular_data.nome }}
                    <small class="float-end">{{ titular_data.cpf_cnpj|mask:'cpf_cnpj' }}</small>
                </div>
                <div class="titular-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Banco:</strong> {{ titular_data.banco }}
                        </div>
                        <div class="col-md-4">
                            <strong>Agência:</strong> {{ titular_data.agencia }}
                        </div>
                        <div class="col-md-4">
                            <strong>Conta:</strong> {{ titular_data.conta }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card"
                                style="border: none; border-left: 4px solid #28a745; background-color: #f8f9fa; border-radius: 10px;">
                                <div class="card-body text-center">
                                    <h6>Total Créditos</h6>
                                    <h4>{{ titular_data.creditos|mask:'moeda' }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card"
                                style="border: none; border-left: 4px solid #dc3545; background-color: #f8f9fa; border-radius: 10px;">
                                <div class="card-body text-center">
                                    <h6 class="text-danger">Total Débitos</h6>
                                    <h4 class="text-danger">{{ titular_data.debitos|mask:'moeda' }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card"
                                style="border-radius: 10px; border: none; border-left: 4px solid #007bff; color: #007bff;   ">
                                <div class="card-body text-center">
                                    <h6>Saldo</h6>
                                    <h4>{{ titular_data.saldo|mask:'moeda' }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6>Transações ({{ titular_data.transacoes|length }}):</h6>
                    {% for transacao in titular_data.transacoes %}
                    <div
                        class="transacao-item {% if transacao.natureza_lancamento == 'C' %}transacao-credito{% else %}transacao-debito{% endif %}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ transacao.data_lancamento|date:"d/m/Y" }}</strong>
                                <br>
                                <small class="text-muted">{{ transacao.descricao_lancamento }}</small>
                            </div>
                            <div class="text-end">
                                <strong
                                    class="{% if transacao.natureza_lancamento == 'C' %}text-success{% else %}text-danger{% endif %}">
                                    {{ transacao.valor_transacao|mask:'moeda' }}
                                </strong>
                                <br>
                                <small class="text-muted">
                                    {% if transacao.natureza_lancamento == 'C' %}Crédito{% else %}Débito{% endif %}
                                </small>
                            </div>
                        </div>
                        {% if transacao.cpf_cnpj_od and transacao.nome_pessoa_od %}
                        <div class="mt-2">
                            <small class="text-muted">
                                <strong>Contraparte:</strong> {{ transacao.nome_pessoa_od }} 
                                ({{ transacao.cpf_cnpj_od|mask:'cpf_cnpj' }})
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Todas as Transações -->
    <div class="card card-detalhes">
        <div class="card-header-custom">
            <i class="fa fa-list"></i> Todas as Transações ({{ todas_transacoes|length }})
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="tabela-transacoes">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Titular</th>
                            <th>CPF/CNPJ Titular</th>
                            <th>Contraparte</th>
                            <th>CPF/CNPJ Contraparte</th>
                            <th>Descrição</th>
                            <th>Valor</th>
                            <th>Natureza</th>
                            <th>Cooperação</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transacao in todas_transacoes %}
                        <tr>
                            <td>{{ transacao.data_lancamento|date:"d/m/Y" }}</td>
                            <td>{{ transacao.nome_titular }}</td>
                            <td>{{ transacao.cpf_cnpj_titular|mask:'cpf_cnpj' }}</td>
                            <td>{{ transacao.nome_pessoa_od }}</td>
                            <td>{{ transacao.cpf_cnpj_od|mask:'cpf_cnpj' }}</td>
                            <td>{{ transacao.descricao_lancamento }}</td>
                            <td
                                class="{% if transacao.natureza_lancamento == 'C' %}text-success{% else %}text-danger{% endif %}">
                                {{ transacao.valor_transacao|mask:'moeda' }}
                            </td>
                            <td>
                                <span
                                    class="badge {% if transacao.natureza_lancamento == 'C' %}bg-success{% else %}bg-danger{% endif %}">
                                    {% if transacao.natureza_lancamento == 'C' %}Crédito{% else %}Débito{% endif %}
                                </span>
                            </td>
                            <td>{{ transacao.cooperacao.numero }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Análise IA -->
<div class="modal fade" id="modalAnaliseIA" tabindex="-1" aria-labelledby="modalAnaliseIALabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAnaliseIALabel">
                    <i class="fa fa-robot"></i> Análise com IA
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="loading-analise" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Analisando dados com IA...</p>
                </div>
                <div id="conteudo-analise"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Marked.js para formatação de markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Dados dos gráficos
    const dadosGrafico = {{ dados_grafico| safe }};
    const dadosLinha = {{ dados_linha| safe }};

    document.addEventListener('DOMContentLoaded', function () {

        // Tabela de transações
        const table = $('#tabela-transacoes');
        if (table.length) {
            const dataTable = table.DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
                }
            });
        }

        // Gráfico de pizza - Créditos vs Débitos
        const ctxPizza = document.getElementById('grafico-pizza').getContext('2d');
        new Chart(ctxPizza, {
            type: 'doughnut',
            data: dadosGrafico,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Gráfico de linha - Movimentação ao longo do tempo
        const ctxLinha = document.getElementById('grafico-linha').getContext('2d');
        new Chart(ctxLinha, {
            type: 'line',
            data: dadosLinha,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
            }
        });

        // Funcionalidade do botão Análise com IA
        document.getElementById('btn-analise-ia').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('modalAnaliseIA'));
            const loadingDiv = document.getElementById('loading-analise');
            const conteudoDiv = document.getElementById('conteudo-analise');
            
            // Mostra o modal
            modal.show();
            
            // Mostra loading
            loadingDiv.classList.remove('d-none');
            conteudoDiv.innerHTML = '';
            
            // Dados para enviar
            const dados = {
                cpf_cnpj: '{{ pessoa.cpf_cnpj }}',
                nome: '{{ pessoa.nome }}'
            };
            
            // Faz a requisição AJAX
            fetch('{% url "bancaria:analise_ia_detalhes_pessoa" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(data => {
                // Esconde loading
                loadingDiv.classList.add('d-none');
                
                if (data.success) {
                    // Converte markdown para HTML
                    const htmlContent = marked.parse(data.analise);
                    conteudoDiv.innerHTML = htmlContent;
                } else {
                    conteudoDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fa fa-exclamation-triangle"></i>
                            Erro na análise: ${data.error || 'Erro desconhecido'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                loadingDiv.classList.add('d-none');
                conteudoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fa fa-exclamation-triangle"></i>
                        Erro na comunicação com o servidor
                    </div>
                `;
            });
        });
    });
</script>
{% endblock %}