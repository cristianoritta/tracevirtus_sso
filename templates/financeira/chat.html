{% extends "layout/base.html" %}

{% block title %}Chat de Análise Financeira{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="nk-content-inner">
        <div class="nk-content-body">
            <div class="nk-block-head nk-block-head-sm">
                <div class="nk-block-between">
                    <div class="nk-block-head-content">
                        <h3 class="nk-block-title page-title">Chat de Análise Financeira</h3>
                        <div class="nk-block-des text-soft">
                            <p>Faça perguntas sobre os dados financeiros do caso ativo.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nk-block">
                <div class="card card-bordered">
                    <div class="card-inner">
                        <div id="chat-container" class="nk-chat-body" style="height: 500px; overflow-y: auto; padding: 20px;">
                            <!-- As mensagens do chat aparecerão aqui -->
                            <div class="chat-message assistant">
                                <div class="chat-content">
                                    <p>Olá! Sou seu assistente de análise financeira. Como posso ajudar a analisar os dados do caso ativo hoje?</p>
                                </div>
                            </div>
                        </div>
                        <div class="nk-chat-editor" style="padding-top: 20px;">
                             <form id="chat-form" class="nk-chat-editor-form">
                                <div class="nk-chat-editor-upload  d-flex align-items-center">
                                     <input type="text" class="form-control form-control-simple" id="prompt-input" placeholder="Digite sua pergunta..." autocomplete="off">
                                    <ul class="nk-chat-editor-tools g-2">
                                        <li>
                                            <button type="submit" class="btn btn-round btn-primary btn-icon"><em class="icon ni ni-send-alt"></em></button>
                                        </li>
                                    </ul>
                                </div>
                             </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM carregado. Iniciando script do chat.");
    const chatForm = document.getElementById('chat-form');
    const promptInput = document.getElementById('prompt-input');
    const chatContainer = document.getElementById('chat-container');

    if (!chatForm) {
        console.error("Formulário do chat não encontrado!");
        return;
    }
    console.log("Formulário do chat encontrado:", chatForm);

    chatForm.addEventListener('submit', function(e) {
        console.log("Formulário enviado.");
        e.preventDefault();
        const prompt = promptInput.value.trim();
        console.log("Prompt do usuário:", prompt);

        if (prompt) {
            addMessageToChat('user', prompt);
            promptInput.value = '';
            sendPromptToBackend(prompt);
        } else {
            console.log("Prompt vazio. Não enviado.");
        }
    });

    function addMessageToChat(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', role);
        
        const contentDiv = document.createElement('div');
        contentDiv.classList.add('chat-content');
        
        const p = document.createElement('p');
        p.innerHTML = content.replace(/\n/g, '<br>');
        
        contentDiv.appendChild(p);
        messageDiv.appendChild(contentDiv);
        chatContainer.appendChild(messageDiv);
        
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function sendPromptToBackend(prompt) {
        console.log("Enviando prompt para o backend:", prompt);
        addMessageToChat('assistant', '<div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">Loading...</span></div>');

        fetch("{% url 'financeira:financeira_chat_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ prompt: prompt })
        })
        .then(response => {
            console.log("Resposta recebida do backend.");
            return response.json();
        })
        .then(data => {
            // Remove spinner
            const lastMessage = chatContainer.querySelector('.chat-message:last-child .chat-content');
            if(lastMessage) lastMessage.parentElement.remove();

            if (data.response) {
                addMessageToChat('assistant', data.response);
            } else {
                addMessageToChat('assistant', 'Desculpe, ocorreu um erro: ' + (data.error || 'Erro desconhecido.'));
            }
        })
        .catch(error => {
            const lastMessage = chatContainer.querySelector('.chat-message:last-child .chat-content');
            if(lastMessage) lastMessage.parentElement.remove();
            
            console.error('Erro no fetch:', error);
            addMessageToChat('assistant', 'Desculpe, ocorreu um erro de comunicação com o servidor.');
        });
    }
});
</script>

<style>
.chat-message {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
}
.chat-message.user {
    align-items: flex-end;
}
.chat-message.assistant {
    align-items: flex-start;
}
.chat-content {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 20px;
    word-wrap: break-word;
}
.chat-message.user .chat-content {
    background-color: #007bff;
    color: white;
    border-top-right-radius: 0;
}
.chat-message.assistant .chat-content {
    background-color: #f1f0f0;
    color: #333;
    border-top-left-radius: 0;
}
</style>
{% endblock %} 